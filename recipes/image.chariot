custom/image {
    dependencies: [ custom/kernel custom/initramfs package/test_app package/init_system image/xorriso tool/limine source/limine source/kernel ]
    options: [ "arch" ]
    build: <sh>
        mkdir -p iso_root/EFI/BOOT 
        mkdir -p iso_root/boot

        cp $CUSTOM_DIR/kernel/kernel.elf ./iso_root/boot/kernel
        cp $SYSROOT_DIR/usr/bin/init_system.elf ./iso_root/boot/init_system.elf
        cp $SYSROOT_DIR/usr/bin/test.elf ./iso_root/boot/test.elf
        cp $CUSTOM_DIR/initramfs/initramfs.tar ./iso_root/boot/initramfs.tar

        cp $SOURCES_DIR/kernel/limine.conf ./iso_root
        cp $SOURCES_DIR/limine/limine-uefi-cd.bin ./iso_root
        cp $SOURCES_DIR/limine/BOOTX64.EFI ./iso_root/EFI/BOOT
        cp $SOURCES_DIR/limine/BOOTIA32.EFI ./iso_root/EFI/BOOT
        cp $SOURCES_DIR/limine/BOOTAA64.EFI ./iso_root/EFI/BOOT

        if [ "$OPTION_arch" = "x86_64" ]; then
            cp $SOURCES_DIR/limine/limine-bios-cd.bin ./iso_root
            cp $SOURCES_DIR/limine/limine-bios.sys ./iso_root
        fi
        xorriso -as mkisofs \
    		-no-emul-boot -boot-load-size 4 -boot-info-table \
            -b limine-bios-cd.bin \
    		--efi-boot limine-uefi-cd.bin \
    		-efi-boot-part --efi-boot-image --protective-msdos-label \
    		iso_root -o output.iso
        if [ "$OPTION_arch" = "x86_64" ]; then
            limine bios-install output.iso
        fi
        rm -r iso_root
    </sh>
    install: <sh>install output.iso $INSTALL_DIR</sh>
}